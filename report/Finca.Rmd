---
title: "Producción de la finca"
date: "Agosto 2022"
output:
  html_document:
    theme: yeti
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
params:
  new_coop: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      message = F,
                      warning = F)

library(tidyverse)
library(lubridate)
library(kableExtra)
# library(glue)
library(here)

### standardize ggplot theme
#theme_set(theme_classic())
#theme_set(theme_minimal())
theme_set(theme_light())

# los decimales con comas, de forma general
options(OutDec = ",")
```

```{r dataload}

if (isTRUE(params$new_coop)) {
  # actualizo las gráficas, cargo datos_mes y obtengo datos_mes_kg
  source(file = here("eda/", "coop_graficas.R"))
} else {
  # cargo datos_mes y obtengo datos_mes_kg
  source(file = here("eda/", "coop_graficas_datos.R"))
}

# esto es lo anterior, ver si algo es útil

load(here("data/processed", "ds_cooperativa.RData"))

peso_mes_cat <- datos_mes %>% 
  select(mes, ends_with("_kg")) %>% 
  pivot_longer(
    -mes,
    names_to  = "categoria",
    values_to = "valor"
  ) %>% 
  filter(categoria != "total_kg") %>% 
  mutate(
    categoria = str_remove(categoria, "_kg") %>% str_to_sentence()
  )

precios_mes_cat <- datos_mes %>% 
  select(mes, ends_with(c("_kg", "_eur"))) %>% 
  mutate(
    total   = total_eur / total_kg,
    premium = premium_eur / premium_kg,
    psup    = psup_eur / psup_kg,
    segunda = segunda_eur / segunda_kg,
    .keep   = "unused"
  )
```

# Introducción

Para la evolución mensual se han agregado los datos en función de la fecha del mes del documento de liquidación.

Actualmente la información abarca de las anualidades a partir de 2020. Sin embargo, de 2020 sólo se dispone de datos del mes de Diciembre, por lo que no se tiene en cuenta de momento.

# Evolución general

La evolución de la relación entre el peso cortado mensualmente y la liquidación es como se muestra a continuación.

```{r rel-eurkg}
knitr::include_graphics(path = here("report/graphs", "eur_kg.png"))
```

La evolución del peso de los cortes mensuales y el número de racimos ha sido la siguiente.

```{r evol_racskg}
knitr::include_graphics(path = here("report/graphs", "mes_racskg.png"))
```

La evolución del peso de los racimos es la siguiente

```{r evol-kgracs}
knitr::include_graphics(path = here("report/graphs", "kg_racimo.png"))
```

# Evolución del peso

Para el total general del peso de las liquidaciones, tenemos

```{r vs-kg_mmaa}
knitr::include_graphics(path = here("report/graphs", "mes_aa_total_kg.png"))
```

```{r vs-kg-acum-aa}
knitr::include_graphics(path = here("report/graphs", "mes_aa_total_kg_acum.png"))
```

Si lo hacemos por categorías

```{r vs-kgcat_mmaa}
knitr::include_graphics(path = here("report/graphs", "mes_aa_total_kg_cat.png"))
```

```{r vs_kgcat_acum_aa}
knitr::include_graphics(path = here("report/graphs", "mes_aa_total_kg_cat_acum.png"))
```

<!--
## Acumulado mensual de las variables generales

Evolución mensual del acumulado semanal del número de racimos, peso total, importe total y el total de las facturas.

```{r totales-mes}
datos_mes %>% 
  select(mes:total_fac) %>% 
  pivot_longer(
    -mes,
    names_to = "tipo",
    values_to = "valor"
  ) %>% 
  mutate(
    tipo = if_else(str_detect(tipo, "fac"), "total_factura", tipo) %>%
      str_replace("_", " ") %>% str_to_title()
  ) %>%
  ggplot(aes(x = mes)) +
  geom_bar(aes(weight = valor)) +
  facet_wrap(
    ~factor(tipo, c("Racimos", "Total Kg", "Total Eur", "Total Factura")), 
    ncol = 1, scales = "free_y") +
  labs(
    y = NULL,
    caption = "Total Eur es el importe total de los cortes, y Total Factura el importe de las facturas."
    )
```

## Peso mensual por categoría

Evolución del peso mensual (Kg), por categoría

```{r peso-mensual}
 peso_mes_cat %>% 
  ggplot(aes(mes, valor)) +
  geom_line() +
  facet_wrap(~categoria, ncol = 1) +
  labs(y = "Kg")
  
```

Evolución del porcentaje, en peso, de cada categoría

```{r peso-mensual-prc}
peso_mes_cat %>% 
  pivot_wider(
    names_from = "categoria",
    values_from = "valor"
  ) %>% 
  mutate(
    total = Premium + Psup + Segunda,
    across(Premium:Segunda, ~round(.x / total * 100, digits = 2), .names = "{.col}_prc")
  ) %>% 
  select(mes, ends_with("_prc")) %>% 
  pivot_longer(
    -mes,
    names_to = "cat",
    values_to = "valor"
  ) %>% 
  mutate(
    cat = str_remove(cat, "_prc")
  ) %>% 
  ggplot(aes(x = mes, y = valor, color = cat)) +
  geom_line(size = 1) +
  labs(
    y = "Porcentaje",
    color = "Categoría")
```

## Precios por categorías

Evolución mensual del precio en cada categoría, en negro la media del precio percibido.

```{r precio-mes}
precios_mes_cat %>% 
  select(-total) %>% 
  pivot_longer(
    -mes,
    names_to  = "cat",
    values_to = "valor"
  ) %>% 
  ggplot(aes(x = mes, y = valor)) +
  geom_line(aes(color = cat)) +
  geom_line(data = select(precios_mes_cat, mes, total), aes(x = mes, y = total)) +
  labs(
    y = "€ / Kg",
    color = "categoría"
  )
```

# Comparativa mensualidades anuales

## Variables principales

```{r tot-mes-anyo}

ds <- datos_mes %>% 
  select(mes:total_fac) %>% 
  group_by(aa = year(mes), mm = month(mes, label = TRUE)) %>% 
  summarise(
    across(racimos:total_fac, sum),
    .groups = "drop"
    ) %>% 
  pivot_longer(
    cols      = !c(aa, mm),
    names_to  = "tipo",
    values_to = "valor"
  ) %>% 
  mutate(
    tipo = if_else(str_detect(tipo, "fac"), "total_factura", tipo) %>%
      str_replace("_", " ") %>% str_to_title()
  )

ds %>% 
  ggplot(
    aes(x = mm, y = valor, fill = as_factor(aa))
  ) +
  geom_col(position = "dodge") +
  facet_wrap(
    ~factor(tipo, c("Racimos", "Total Kg", "Total Eur", "Total Factura")),
    ncol = 1, scales = "free_y"
    ) +
  labs(
    x = NULL, y = NULL, fill = "Anualidades",
    caption = "Total Eur es el importe total de los cortes, y Total Factura el importe de las facturas."
    )
```

## Pesos de las categorías

```{r cat-pesos-mes-anyo}
peso_mes_cat %>% 
  mutate(
    aa = year(mes), mm = month(mes, label = TRUE),
    .keep = "unused"
  ) %>% 
  ggplot(
    aes(x = mm, y = valor, fill = as_factor(aa))
  ) +
  geom_col(position = "dodge") +
  facet_wrap(~categoria, ncol = 1, scales = "free_y") +
  labs(x = NULL, y = NULL, fill = "Anualidades")
```

Respecto al peso total, la comparativa es la siguiente

```{r dif-peso-mes}
peso_mes_cat %>% 
  group_by(aa = year(mes), mm = month(mes, label = TRUE)) %>% 
  summarise(
    peso = sum(valor),
    .groups = "drop"
  ) %>% 
  pivot_wider(
    names_from = aa,
    values_from = peso
  ) %>% 
  arrange(mm) %>% 
  rename(Mes = mm) %>% 
  kbl(
    format.args = list(big.mark = '.')
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
  
```

```{r peso-mes-anyo}
peso_mes_cat %>% 
  group_by(aa = year(mes), mm = month(mes, label = TRUE)) %>% 
  summarise(
    peso = sum(valor),
    .groups = "drop"
  ) %>% 
  ggplot(
    aes(x = mm, y = as_factor(aa), fill = peso)
  ) +
  geom_tile() +
  labs(x = NULL, y = NULL, fill = "Kg")
```

## Precios

```{r precios-mes-anyo}
precios_mes_cat %>% 
  select(-total) %>% 
  pivot_longer(
    cols      = -mes,
    names_to  = "cat",
    values_to = "precio"
  ) %>% 
  ggplot(
    aes(x = month(mes, label = TRUE), y = precio, fill = as_factor(year(mes)))
  ) +
  geom_col(position = "dodge") +
  facet_wrap(~cat, ncol = 1) +
  labs(x = NULL, y = NULL, fill = "Anualidades")
```

Considerando el precio total de cada corte, es decir, la relación entre el total de kg y el del importe de las liquidaciones, tenemos

```{r precios-totales-anyo}
precios_mes_cat %>% 
  select(mes, total) %>% 
  ggplot(
    aes(x = month(mes, label = TRUE), y = total, fill = as_factor(year(mes)))
  ) +
  geom_col(position = "dodge") +
  labs(x = NULL, y = NULL, fill = "Anualidades")
```

-->