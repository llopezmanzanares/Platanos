---
title: "Producción de plátanos"
date: "`r Sys.Date()`"
lang: es
execute: 
  echo: false
  warning: false
crossref: 
  fig-title: "Figura"
  fig-prefix: "Figura"
  tbl-title: "Tabla"
  tbl-prefix: "Tabla"
format: 
  html:
    theme: lux
    toc: true
    toc-depth: 2
    number-sections: true
    embed-resources: true
    fig-width: 10
    page-layout: full
    grid:
      sidebar-width: 50px
      body-width: 1200px
      margin-width: 200px
knitr: 
  opts_chunk:
    echo: false
    warning: false
    message: false
---

```{r}
#| label: set-up
#| include: false

library(tidyverse)
library(ggdist)
library(patchwork)
library(here)
library(gt)
library(gtExtras)

theme_set(
  # theme_minimal()
  theme_light(base_size = 14)
)

eur <- scales::label_currency(suffix = "€", prefix = NULL,
                              big.mark = ".", decimal.mark = ",")

# mi paleta de colores
col_pal <- c("blanco" = "white", "cream" = "#f4f7be", "mindaro" = "#e5f77d", "ecru" = "#deba6f",
             "wine"  = "#823038", "licoire" = "#1e000e")

```

```{r}
#| label: data-load

load(here("data/processed/datos_finca.RData"))
load(here("data/processed/graficas_finca.RData"))
load(here("data/processed/istac_platanos.RData"))
load(here("data/processed/istac_graficas.RData"))

# rango de los datos de las gráficas de la cooperativa
coop_rng <- range(coop_grafs$eur_kg$data$fecha)
# rango de los datos del istac
istac_rng <- range(istac_grafs$pre_sem$data$aa)

# anualidades completas
aamm_full <-
  tibble(
    aa = rep(year(coop_rng[1]):year(coop_rng[2]), each = 12),
    mm = rep(1:12, year(coop_rng[2])-year(coop_rng[1]) + 1) |> 
      month(label = TRUE)
  )

# para ggplot_col_mm
coop_mm <- 
   select(coop_ds$mes, fecha:total_eur) |> 
  mutate(aa = year(fecha), mm = month(fecha, label = TRUE), .after = fecha) |> 
  pivot_longer(cols = racimos:total_eur)
```

```{r}
#| label: my-fn

# gráfica de columnas mensuales para los datos de la cooperativa
ggplot_cols_mm <- function(data_sel, aa_sel){
  
  # selecciono los datos
  coop_mm |> 
    filter(aa == parse_number(aa_sel), name == data_sel) |> 
    
    # genero la gráfica
    ggplot(aes(x = mm, y = value)) +
    geom_col(fill = col_pal["ecru"]) +
    # simplifico la grafica
    theme_minimal() +
    scale_x_discrete(breaks = NULL) +
    scale_y_continuous(breaks = NULL) +
    labs(x = element_blank(), y = element_blank())
  
  
}
```


# Producción de la Finca

Datos para el periodo `r coop_rng[1]` a `r coop_rng[2]`

```{r}
#| label: resumen
#| eval: false

coop_ds$mes |>  
  select(racimos:total_eur) |>  
  rename(
    Racimos  = racimos,
    Peso     = total_kg,
    Ingresos = total_eur
  ) |>  
  gt_plt_summary() |> 
  tab_options(table.width = pct(60)) |> 
  tab_header(
    title    = "Resumen de valores mensuales",
    subtitle = "Desde 2021"
  )  |>  
  cols_hide(columns = c(n_missing)) |> 
  fmt_integer(columns = c(Mean:SD), sep_mark = ".") |>  
  cols_label(
    name = "COLUMN", value = NULL,
    name = "Column", value="Histograma",
    Mean = "Media",
    Median = "Mediana",
    SD = "Desv. Est."
  )
```

```{r}
#| label: tabla-resumen

coop_mm_summary <- 
  coop_ds$mes |> 
  select(fecha:total_eur) |> 
  mutate(aa = year(fecha), .keep = "unused") |> 
  rename_with(.cols = starts_with("total"), .fn = ~str_extract(.x, pattern = "[:lower:]+$")) |> 
  pivot_longer(cols = !aa) |> 
  mutate(
    name = case_when(
      name == "kg"  ~ "Peso",
      name == "eur" ~ "Precio",
      .default =      "Racimos"
    )
  ) |> 
  summarise(
    .by = c(aa, name),
    total = sum(value),
    prom  = mean(value),
    media = median(value),
    estdv = sd(value),
    datos = list(value)
  )

coop_mm_summary |> 
  relocate(datos, .after = total) |> 
  gt(
    rowname_col = "aa", #groupname_col = "name",
    locale = "es"
    ) |> 
  tab_options(table.width = pct(60)) |> 
  tab_header(title = "Resumen de valores mensuales") |> 
  tab_row_group(label = md("**Racimos**"), rows = str_detect(name, "Racimos"), id = "racs") |> 
  tab_row_group(label = md("**Pesos (Kg)**"), rows = str_detect(name, "Peso"), id = "kg") |> 
  tab_row_group(label = md("**Facturado (€)**"), rows = str_detect(name, "Precio"), id = "eur") |> 
  cols_hide(columns = name) |> 
  gt_theme_538() |>
  fmt_number(columns = c(total:estdv), decimals = 0) |> 
  fmt_currency(
    columns = c(total:estdv), rows = c(3,6,9), #locale = "es", 
    decimals = 0, placement = "right", incl_space = TRUE
    ) |> 
  tab_style(
    style = cell_text(size = 8), 
    locations = cells_body(columns = c(total:estdv))
  ) |>
  cols_label(
    total = "Acumulado", datos = "Distribución",
    prom  = "Media", media = "Mediana", estdv = "Desv. Est."
  ) |> 
  gt_plt_dist(
    column = datos, #type   = "histogram",
    fill_color = col_pal["mindaro"], line_color = col_pal["ecru"],
    same_limit = FALSE
    )
```


```{r}
#| label: tabla-resumen-mm

left_join(
  aamm_full,
  coop_ds$mes |> 
    select(fecha:total_eur) |> 
    mutate(aa = year(fecha), mm = month(fecha, label = TRUE), .keep = "unused"),
  join_by(aa, mm)
) |> 
  pivot_longer(cols = racimos:total_eur) |> 
  pivot_wider(names_from = mm, values_from = value) |> 
  # mutate(name = str_replace(name, "_", " ") |> str_to_sentence()) |> 
  mutate(.by = c(name, aa), grafica = list(c(name, aa)), .after = name) |> 
  
  # la tabla
  gt(
    locale = "es",
    rowname_col = "aa", groupname_col = "name"
  ) |> 
  tab_header(title = "Comparativa de valores mensuales") |> 
  # formatos numéricos
  fmt_number(
    columns = c("ene":"dic"),
    decimals = 0
  ) |> 
  
  #heat map
  data_color(
    columns = c("ene":"dic"), direction = "row",
    palette = col_pal, apply_to = "fill"
  ) |> 
  
  # las gráficas
  text_transform(
    locations = cells_body(columns = "grafica"),
    fn = function(column) {
      map(column, ~str_split_1(., ", ")) |> 
        map(~ggplot_cols_mm(.[1], .[2])) |> 
        ggplot_image(height = px(30), aspect_ratio = 3)
    }
  )

```

```{r}
#| label: indicadores

ds <- 
  coop_ds$mes |> 
  select(fecha, total_kg, total_eur) |> 
  mutate(
    aa = year(fecha), mm = month(fecha, label = TRUE),
    eur_kg = round(total_eur / total_kg, 2)
  )

ds_aa <- filter(ds, mm == min(mm)) |> select(aa:eur_kg)

ggplot(ds, aes(x = mm, y = eur_kg, color = as_factor(aa))) +
  geom_line(aes(group = aa), linewidth = 1) +
  ggrepel::geom_text_repel(data = ds_aa, aes(label = aa, x = mm, y = eur_kg)) +
  labs(
    title = "Relación entre el precio y el peso de la producción (€ vs Kg)",
    x = element_blank(), y = element_blank()
  ) +
  theme(plot.title.position = "plot", legend.position = "none") +
  scale_y_continuous(labels = scales::label_number(decimal.mark = ","))

```



## Distribución semanal del peso (Kg)

```{r}
#| label: kg-vs-aa
#| fig-height: 8

coop_grafs$dist_kg / coop_grafs$dist_kg_aa
```

## Evolución mensual

```{r}
#| label: evol-mm-kg

coop_ds$mes |> 
  ggplot(aes(x = fecha, y = total_kg)) +
  geom_point(shape = 21, fill = col_pal["cream"], color = col_pal["wine"]) +
  geom_smooth(
    method = "loess", formula = y ~ x,
    color = col_pal["wine"], fill = col_pal["cream"]
    ) +
  labs(
    title = "Evolución de la producción mensual (Kg)",
    x = NULL, y = NULL
  ) +
  theme(plot.title.position = "plot") +
  scale_y_continuous(labels = scales::label_number(big.mark = "."))
```

```{r}
#| label: evol-mm-eur

coop_ds$mes |> 
  ggplot(aes(x = fecha, y = total_eur)) +
  geom_point(shape = 21, fill = col_pal["cream"], color = col_pal["wine"]) +
  geom_smooth(
    method = "loess", formula = y ~ x,
    color = col_pal["wine"], fill = col_pal["cream"]
    ) +
  labs(
    title = "Evolución de la producción mensual (€)",
    x = element_blank(), y = element_blank()
  ) +
  theme(plot.title.position = "plot") +
  scale_y_continuous(labels = eur)
```

```{r}
#| label: premiun-prop

coop_ds$mes |> 
  select(fecha, matches("total|prem")) |> 
  mutate(
    prc_kg  = premium_kg / total_kg,
    prc_eur = premium_eur / total_eur,
    .keep   = "unused"
  ) |> 
  pivot_longer(cols = !fecha) |> 
  mutate(name = if_else(str_detect(name, "eur"), "Precio", "Peso")) |> 
  ggplot(aes(x = fecha, y = value)) +
  geom_line(aes(color = name), linewidth = 1) +
  labs(
    title = "Porcentaje de categoría Premium",
    x = element_blank(), y = element_blank(), color = element_blank()
  ) +
  theme(plot.title.position = "plot", legend.position = "bottom") +
  scale_y_continuous(labels = scales::label_percent(decimal.mark = ","))
```



## Acumulados anuales

```{r}
#| label: acum-kg


label_txt <- 
  filter(coop_ds$mes_kg, fecha == min(fecha), .by = aa) |> 
  mutate(txt_aa = as_factor(aa))

coop_ds$mes_kg |> 
  mutate(aa_txt = as_factor(aa)) |> 
  ggplot(aes(x = mm, y = total_kg_acum)) +
  geom_line(aes(group = aa_txt, color = aa_txt), linewidth = 0.9) +
  ggrepel::geom_text_repel(
    data = label_txt,
    aes(label = txt_aa, color = txt_aa, x = mm, y = total_kg_acum),
    size = 4
    ) +
  labs(
    title = "Acumulados anuales de los pesos (Kg)", 
    x = element_blank(), y = element_blank(), color = element_blank()
  ) +
  theme(plot.title.position = "plot", legend.position = "none") +
  scale_y_continuous(position = "right", labels = scales::label_number(big.mark = "."))
```

```{r}
#| label: acum-eur

eur_acum <-
  coop_ds$sem |> 
  select(fecha, total_eur) |> 
  mutate(aa = year(fecha), mm = month(fecha, label = TRUE), .after = 1) |> 
  filter(aa > min(aa)) |> 
  summarise(.by = c(aa, mm), eur = sum(total_eur)) |> 
  mutate(.by = aa, eur_cum = cumsum(eur)) |> 
  mutate(aa_txt = as_factor(aa), .before = 1)

lbl_txt <- filter(eur_acum, mm == min(mm), .by = aa)

eur_acum |> 
  ggplot(aes(x = mm, y = eur_cum)) +
  geom_line(aes(group = aa_txt, color = aa_txt), linewidth = 0.9) +
  ggrepel::geom_text_repel(
    data = lbl_txt,
    aes(label = aa_txt, color = aa_txt, x = mm, y = eur_cum),
    size = 4
  ) +
  labs(
    title = "Acumulados anuales del precio percibido (€)",
    x = element_blank(), y = element_blank(), color = element_blank()
  ) +
  theme(plot.title.position = "plot", legend.position = "none") +
  scale_y_continuous(position = "right", labels = eur)


```

## Precio percibido

Se compara el total de la factura (Cooperativa), con el valor de ISTAC.

```{r}
#| label: eur-kg

precio_tef <- 
  filter(istac_ds$precios_sem, territorio == "Tenerife", aa > min(year(coop_ds$sem$fecha))) |> 
  select(-territorio)

coop_ds$sem |> 
  select(fecha, semana, total_kg, total_eur) |> 
  # tengo un solo valor en 2020
  filter(fecha > min(fecha)) |> 
  mutate(aa = year(fecha), precio_coop = total_eur / total_kg) |> 
  select(aa, sem = semana, precio_coop) |> 
  full_join(precio_tef) |>  
  pivot_longer(cols = starts_with("prec")) |> filter(!is.na(value)) |> 
  mutate(
    name    = if_else(name == "precio", "ISTAC", "Cooperativa"),
    sem_txt = if_else(sem < 10, str_c("0", sem), as.character(sem)),
    fecha   = str_c(aa, sem_txt, "04", sep = " ") |> as.Date(format = "%Y %W %w")
    ) |> 
  select(fecha, name, value) |> 
  ggplot(aes(x = fecha, y = value)) +
  geom_line(aes(group = name, color = name), linewidth = 1) +
  labs(
    title = "Comparativa de valor percibido (€/Kg)",
    x = element_blank(), y = element_blank(), color = element_blank()
  ) +
  theme(plot.title.position = "plot", legend.position = "bottom") +
  scale_y_continuous(position = "right", labels = eur)
```



# Producción de plátano en Canarias

## Precios percibidos por el agricultor

Datos para el periodo `r istac_rng[1]` a `r istac_rng[2]`

```{r}
#| label: istac-precios-sem
#| fig-height: 7

istac_grafs$pre_sem +
  labs(
    subtitle = glue::glue(
      'Valores máximos y mínimos, ',
      '<span style=color:{col_pal["ecru"]}>media</span>, ',
      '<span style=color:{col_pal["wine"]}>última anualidad</span> y ',
      '<span style=color:{"#333333"}>semana 34</span>'
    )
  ) +
  theme(
    plot.subtitle   = ggtext::element_markdown(),
    legend.position = "none"
  ) +
  scale_y_continuous(labels = eur)

```

```{r}
#| label: eu-precios

# cambiar fecha 01-01-17 a 31-12-16

ds <- 
  readxl::read_xlsx(
    path  = here::here("data/raw/bananas_wholesale-proces_feb24.xlsx"),
    sheet = "data EU",
    skip  = 2
  ) |> 
  select(week, `ending on`, ES) |> 
  # hay un problema con como cuentan las semanas
  mutate(
    aa = year(`ending on`),
    wk = week(`ending on`),
    # precio de 100 Kg, lo paso a Kg
    pr = ES / 100,
    .keep = "none"
    ) |> 
  mutate(
    mx_pr = max(pr, na.rm = TRUE),
    mn_pr = min(pr, na.rm = TRUE),
    md_pr = median(pr, na.rm = TRUE),
    .by   = wk
  )

ds_lastaa <- filter(ds, aa == max(aa)) |> select(aa:pr)

ds |> 
  ggplot(aes(x = wk)) +
  geom_ribbon(aes(ymin = mn_pr, ymax = mx_pr), fill = "#e5f77d", color = "#DEBA6F") +
  geom_line(aes(y = md_pr), color = "#DEBA6F", linewidth = 0.9) +
  geom_line(data = ds_lastaa, aes(x = wk, y = pr), color = "#823038", linewidth = 0.9) +
  geom_vline(xintercept = 34, color = "#333333") +
  labs(
    title = "Evolución del rango de precios (€/Kg)",
    subtitle = glue::glue(
      'Valores máximos y mínimos, ',
      '<span style=color:{col_pal["ecru"]}>media</span>, ',
      '<span style=color:{col_pal["wine"]}>última anualidad</span> y ',
      '<span style=color:{"#333333"}>semana 34</span>'
    ),
    caption = "Fuente: Members States and UK notifications pursuant to Art 1 and Annex I (5) of Commission Regulation (EU) 2017/1185",
    x = "Semana", y = element_blank()
  ) +
  theme(
    plot.subtitle = ggtext::element_markdown(),
    plot.caption = element_text(size = 10),
    legend.position = "none"
  ) +
  scale_y_continuous(labels = eur)

  
```


## Evolución de la producción

```{r}
#| label: istac-prod-canarias

istac_grafs$tn_canarias

```

```{r}
#| label: istac-produccion

istac_grafs$tn
```

```{r}
#| label: istac-exports
#| fig-height: 7

istac_grafs$exp_tot +
  labs(
    subtitle = glue::glue(
      'Valores máximos y mínimos, ',
      '<span style=color:{col_pal["ecru"]}>media</span> y ',
      '<span style=color:{col_pal["wine"]}>último año</span>'
    )
  ) +
  theme(
    plot.subtitle = ggtext::element_markdown(),
    legend.position = "none"
  ) +
  scale_y_continuous(labels = scales::label_number(big.mark = "."))
```

## Evolución de la superficie cultivada

```{r}
#| label: istac-superficies

istac_grafs$sup

```

## Relación entre producción y exportación

```{r}
#| label: istac-prod-vs-exp

col_pe <- c("Producción" = "#e69f00", "Exportación" = "#009e73")



# cambiar colores en el título y quitar leyenda
istac_grafs$prodvsexps +
  labs(
    title = glue::glue(
      'Comparativa de la ',
      '<span style=color:{col_pe["Producción"]}>Producción</span> y ',
      '<span style=color:{col_pe["Exportación"]}>Exportación</span> anual (Tn)'
    )
  ) +
  theme(plot.title = ggtext::element_markdown(), legend.position = "none") +
  scale_color_manual(values = col_pe)

```

Las exportaciones incluyen tanto a península como al extranjero, por lo que podemos ver en qué mercado se ha producido la disminución.



Por tanto, suponiendo que lo que no se exporta se destina al mercado interno, la evolución de este indicador es la siguiente

```{r}
#| label: istac-consinterno

istac_grafs$cons_propio

```

# En Profundidad (experimental)

```{r}
#| label: all-ds

# todas las semanas de todos los años (considero 53)
tiempo <- 
  tibble(
    aa  = rep(year(coop_rng[1]):year(coop_rng[2]), each = 53),
    semana = rep(1:53, year(coop_rng[2])-year(coop_rng[1]) + 1)
    )

# año y semana de todos los datos, a partir de 2021
coop_sem_small <- 
  coop_ds$sem |> 
  mutate(aa = year(fecha), .before = 1, .keep = "unused") |> 
  filter(aa > 2020)

# agrupo ambos conjuntos de datos  
ds <-
  left_join(
    tiempo,
    coop_sem_small,
    join_by(aa, semana)
  ) |> 
  # si no hay datos es que ha sido 0 esa semana
  mutate(across(!aa:semana, ~replace_na(.x, replace = 0))) |>
  pivot_longer(cols = !aa:semana) |> 
  pivot_wider(names_from = semana, values_from = value) |> 
  filter(name != "total_fac", !str_detect(name, "_med")) |> 
  mutate(
    name_suf = str_extract(name, pattern = "(?<=_)[:lower:]+") |> str_trim(),
    name     = str_extract(name, pattern = "[:lower:]+") |> str_to_title(),
    .after = name
  ) |> 
  mutate(name_suf = replace_na(name_suf, "Uds."))

# tbl_racimos 
filter(ds, name == "Racimos") |> 
  gt(locale = "es", rowname_col = "aa", groupname_col = "name") |> 
  cols_label(name_suf = "") |> 
  fmt_number(decimals = 0, columns = c("1":"53")) |> 
  tab_style(
    style = cell_text(size = 10), 
    locations = cells_body(columns = c("1":"53"))
    ) |> 
  data_color(
    columns = c("1":"53"), direction = "row",
    palette = col_pal, apply_to = "fill"
  )

# tbl_kg
filter(ds, name_suf == "kg", name == "Total") |> 
  gt(locale = "es", rowname_col = "aa", groupname_col = "name") |> 
  cols_label(name_suf = "") |> 
  fmt_number(decimals = 0, columns = c("1":"53")) |> 
  tab_style(
    style = cell_text(size = 10), 
    locations = cells_body(columns = c("1":"53"))
    ) |> 
  data_color(
    columns = c("1":"53"), direction = "row",
    palette = col_pal, apply_to = "fill"
  )

# tbl_eur
filter(ds, name_suf == "eur", name == "Total") |> 
  gt(locale = "es", rowname_col = "aa", groupname_col = "name") |> 
  cols_label(name_suf = "") |> 
  fmt_number(decimals = 0, columns = c("1":"53")) |> 
  tab_style(
    style = cell_text(size = 10), 
    locations = cells_body(columns = c("1":"53"))
    ) |> 
  data_color(
    columns = c("1":"53"), direction = "row",
    palette = col_pal, apply_to = "fill"
  )
```


